{% extends 'base.html' %}

{% block title %}Analytics - Trading Journal{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-gray-900">Trading Analytics</h1>
        <p class="text-gray-600">Detailed analysis of your trading performance</p>
    </div>

    <!-- Setup Performance -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Performance by Setup Type</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setup Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trades</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total P&L</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg P&L</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Win Rate</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for setup in setup_stats %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ setup.setup_type|title }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ setup.count }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if setup.total_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ₹{{ setup.total_pnl|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if setup.avg_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ₹{{ setup.avg_pnl|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ setup.win_rate|floatformat:1 }}%
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            No setup data available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Symbol Performance -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Performing Symbols</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trades</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total P&L</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg P&L</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for symbol in symbol_stats %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ symbol.symbol }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ symbol.count }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if symbol.total_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ₹{{ symbol.total_pnl|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if symbol.avg_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ₹{{ symbol.avg_pnl|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                            No symbol data available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Daily Performance Chart -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Performance (Last 30 Days)</h3>
        <canvas id="dailyChart" width="400" height="200"></canvas>
    </div>

    <!-- Confidence Level Analysis -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Performance by Confidence Level</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trades</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total P&L</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg P&L</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for conf in confidence_stats %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ conf.confidence_level }}/10
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ conf.count }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if conf.total_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ₹{{ conf.total_pnl|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if conf.avg_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ₹{{ conf.avg_pnl|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                            No confidence data available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Daily Performance Chart
    const dailyData = [
        {% for day in daily_stats %}
        {
            date: '{{ day.date|date:"M d" }}',
            pnl: {{ day.total_pnl|floatformat:2 }},
            trades: {{ day.count }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: dailyData.map(item => item.date),
            datasets: [{
                label: 'Daily P&L (₹)',
                data: dailyData.map(item => item.pnl),
                backgroundColor: dailyData.map(item => item.pnl >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                borderColor: dailyData.map(item => item.pnl >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}
